{% extends "base.html" %}

{% block title %}Reports - Administration - JIT Access{% endblock %}

{% block content %}
<header class="PageHeader">
  <div>
    <h1 class="PageTitle">Reports</h1>
    <p class="PageSubtitle">Audit events and operational summary (read-only).</p>
  </div>
  <div class="PageActions">
    <a class="Button" href="{{ url_for('admin_dashboard') }}">Back</a>
  </div>
</header>

<section class="Card" aria-label="Summary">
  <div class="Card__hd">
    <h2 class="Card__title">Summary</h2>
  </div>
  <div class="Card__bd">
    <div class="u-row">
      <span class="Badge Badge--info">Active grants</span>
      <strong style="font-size: 22px; margin-left: 6px;">
        {{ active_grants.Count if active_grants and active_grants.Count is not none else 0 }}
      </strong>
      <span style="color: var(--subtle);">active</span>
    </div>
    <p class="Help" style="margin: var(--s-3) 0 0 0;">
      Audit logs show up to the most recent 100 events.
    </p>
  </div>
</section>

<section class="Card" aria-label="Recent audit events">
  <div class="Card__hd">
    <h2 class="Card__title">Recent Audit Events</h2>
  </div>
  <div class="Card__bd">
    {% if audit_logs %}
      <div class="TableWrap">
        <table class="Table">
          <thead>
            <tr>
              <th>Time (UTC)</th>
              <th>Event</th>
              <th>Actor</th>
              <th>Target</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
            {% for ev in audit_logs %}
              <tr>
                <td>{{ ev.EventUtc.strftime('%Y-%m-%d %H:%M') if ev.EventUtc else (ev.EventTimeUtc or '—') }}</td>
                <td><strong>{{ ev.EventType or ev.EventName or '—' }}</strong></td>
                <td>{{ ev.ActorLoginName or ev.ActorUserId or ev.ActorUser or '—' }}</td>
                <td>{{ ev.TargetLoginName or ev.TargetUserId or ev.TargetUser or '—' }}</td>
                <td>
                  {% set d = ev.Details or ev.Message or ev.Notes %}
                  {{ d[:120] + '…' if d and d|length > 120 else (d or '—') }}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="EmptyState">
        <p class="EmptyState__title">No audit events found</p>
        <p>If this is unexpected, check the database connection.</p>
      </div>
    {% endif %}
  </div>
</section>
{% endblock %}

