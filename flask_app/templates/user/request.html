{% extends "base.html" %}

{% block title %}Request Access - JIT Access{% endblock %}

{% block content %}
<header class="PageHeader">
  <div>
    <h1 class="PageTitle">Request Access</h1>
    <p class="PageSubtitle">Select one or more roles, choose the duration, and provide a justification.</p>
  </div>
  <div class="PageActions">
    <a class="Button Button--ghost" href="{{ url_for('user_dashboard') }}">Back</a>
  </div>
</header>

<section class="Card" aria-label="Request form">
  <div class="Card__hd">
    <h2 class="Card__title">Request Details</h2>
  </div>
  <div class="Card__bd">
    <form class="Form" method="POST" action="{{ url_for('user_request') }}" id="requestForm">
      <div class="Field">
        <label class="Label" for="roles-container">Select roles <span class="Help">(select at least one)</span></label>

        {% if roles %}
          <div id="roles-container" class="TableWrap" tabindex="0" aria-label="Available roles">
            <table class="Table" style="margin: 0;">
              <thead>
                <tr>
                  <th style="width: 56px;"></th>
                  <th>Role</th>
                  <th>Description</th>
                  <th style="width: 160px;">Max Duration</th>
                  <th style="width: 140px;">Ticket</th>
                </tr>
              </thead>
              <tbody>
                {% for role in roles %}
                  <tr class="RoleRow" data-role-id="{{ role.RoleId }}">
                    <td>
                      <input
                        type="checkbox"
                        name="role_id"
                        value="{{ role.RoleId }}"
                        class="RoleCheck"
                        data-max-duration="{{ role.MaxDurationMinutes }}"
                        data-requires-ticket="{{ '1' if role.RequiresTicket else '0' }}"
                        data-ticket-regex="{{ role.TicketRegex or '' }}"
                        data-role-name="{{ role.RoleName }}"
                        id="role_{{ role.RoleId }}"
                        aria-label="Select {{ role.RoleName }}"
                      />
                    </td>
                    <td>
                      <label for="role_{{ role.RoleId }}" style="cursor: pointer;">
                        <strong>{{ role.RoleName }}</strong>
                      </label>
                    </td>
                    <td>{{ role.Description or 'â€”' }}</td>
                    <td>
                      {{ (role.MaxDurationMinutes / 1440) | int }} day{% if (role.MaxDurationMinutes / 1440) | int != 1 %}s{% endif %}
                    </td>
                    <td>
                      {% if role.RequiresTicket %}
                        <span class="Badge Badge--warning">Required</span>
                      {% else %}
                        <span class="Badge">Optional</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="Help" id="roleSelectionMeta" style="display: none;">
            <strong><span id="selectedCount">0</span> role(s) selected</strong>
          </div>
        {% else %}
          <div class="EmptyState">
            <p class="EmptyState__title">No roles available</p>
            <p>You may already have access to all available roles, or you are not eligible for any roles.</p>
          </div>
        {% endif %}
      </div>

      <div class="Field">
        <label class="Label" for="duration_days">Duration (days)</label>
        <input
          class="Input"
          type="number"
          id="duration_days"
          name="duration_days"
          min="1"
          step="1"
          required
          placeholder="e.g., 3"
        />
        <div class="Help" id="duration_help">Select one or more roles to see maximum duration.</div>
      </div>

      <div class="Field">
        <label class="Label" for="justification">Justification</label>
        <textarea
          class="Textarea"
          id="justification"
          name="justification"
          rows="4"
          required
          placeholder="Explain why you need this access..."
        ></textarea>
        <div class="Help">Be specific: system, task, and urgency.</div>
      </div>

      <div class="Field">
        <label class="Label" for="ticket_ref" id="ticket_label">
          Ticket / Reference <span id="ticket_required_indicator" class="Help">(optional)</span>
        </label>
        <input
          class="Input"
          type="text"
          id="ticket_ref"
          name="ticket_ref"
          placeholder="e.g., INC123456"
        />
        <div class="Help" id="ticket_help" style="display: none;"></div>
      </div>

      <div class="u-row u-row--wrap">
        <button type="submit" class="Button Button--primary">Submit Request</button>
        <a class="Button" href="{{ url_for('user_dashboard') }}">Cancel</a>
      </div>
    </form>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    const roleChecks = document.querySelectorAll('.RoleCheck');
    const durationInput = document.getElementById('duration_days');
    const durationHelp = document.getElementById('duration_help');
    const ticketInput = document.getElementById('ticket_ref');
    const ticketHelp = document.getElementById('ticket_help');
    const ticketRequiredIndicator = document.getElementById('ticket_required_indicator');
    const meta = document.getElementById('roleSelectionMeta');
    const selectedCount = document.getElementById('selectedCount');
    const requestForm = document.getElementById('requestForm');
    
    // Convert minutes to days (rounding down)
    function minutesToDays(minutes) {
        return Math.floor(minutes / 1440);
    }
    
    // Get all selected roles' data
    function getSelectedRoles() {
        const selected = [];
        roleChecks.forEach(checkbox => {
            if (checkbox.checked) {
                selected.push({
                    roleId: checkbox.value,
                    maxDurationMinutes: parseInt(checkbox.getAttribute('data-max-duration')) || 10080,
                    requiresTicket: checkbox.getAttribute('data-requires-ticket') === '1',
                    ticketRegex: checkbox.getAttribute('data-ticket-regex') || '',
                    roleName: checkbox.getAttribute('data-role-name') || ''
                });
            }
        });
        return selected;
    }
    
    // Update form based on selected roles
    function updateFormForSelectedRoles() {
        const selected = getSelectedRoles();
        const selectedCountValue = selected.length;
        
        if (meta && selectedCount) {
          if (selectedCountValue > 0) {
              meta.style.display = 'block';
              selectedCount.textContent = String(selectedCountValue);
          } else {
              meta.style.display = 'none';
          }
        }
        
        // Update duration field
        if (selectedCountValue === 0) {
            durationInput.max = '';
            durationHelp.textContent = 'Select one or more roles to see maximum duration';
            durationInput.value = '';
            ticketInput.removeAttribute('required');
            ticketRequiredIndicator.textContent = '(optional)';
            ticketRequiredIndicator.className = 'Help';
            ticketHelp.style.display = 'none';
            ticketInput.value = '';
            return;
        }
        
        // Calculate minimum max duration across all selected roles
        const minMaxDuration = Math.min(...selected.map(r => r.maxDurationMinutes));
        const minMaxDurationDays = minutesToDays(minMaxDuration);
        
        durationInput.max = minMaxDurationDays.toString();
        if (minMaxDurationDays === 1) {
            durationHelp.textContent = 'Maximum 1 day (minimum of selected roles)';
        } else {
            durationHelp.textContent = `Maximum ${minMaxDurationDays} days (minimum of selected roles)`;
        }
        
        // Validate current duration value if it exceeds max
        if (durationInput.value && parseInt(durationInput.value) > minMaxDurationDays) {
            durationInput.value = minMaxDurationDays;
        }
        
        // Check if ANY role requires ticket
        const anyRequiresTicket = selected.some(r => r.requiresTicket);
        
        if (anyRequiresTicket) {
            ticketInput.setAttribute('required', 'required');
            ticketRequiredIndicator.textContent = '(required)';
            ticketRequiredIndicator.className = 'Help';
            ticketInput.placeholder = 'Ticket number or reference (required)';
            
            // Collect all ticket regexes from roles that require tickets
            const ticketRegexes = selected
                .filter(r => r.requiresTicket && r.ticketRegex)
                .map(r => r.ticketRegex);
            
            if (ticketRegexes.length > 0) {
                // Show all formats (might have multiple different formats)
                const uniqueRegexes = [...new Set(ticketRegexes)];
                ticketHelp.textContent = 'Format' + (uniqueRegexes.length > 1 ? 's' : '') + ': ' + uniqueRegexes.join(', ');
                ticketHelp.style.display = 'block';
            } else {
                ticketHelp.style.display = 'none';
            }
        } else {
            ticketInput.removeAttribute('required');
            ticketRequiredIndicator.textContent = '(optional)';
            ticketRequiredIndicator.className = 'Help';
            ticketInput.placeholder = 'Ticket number or reference';
            ticketHelp.style.display = 'none';
        }
    }
    
    // Add event listeners to all checkboxes
    roleChecks.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const row = this.closest('.RoleRow');
            if (row) row.style.background = this.checked ? 'rgba(30, 102, 245, 0.08)' : '';
            updateFormForSelectedRoles();
        });
    });
    
    // Validate ticket format if regex is provided
    ticketInput.addEventListener('blur', function() {
        const selected = getSelectedRoles();
        if (selected.length === 0 || !this.value) {
            this.setCustomValidity('');
            return;
        }
        
        // Check against all selected roles that require tickets and have regex
        const invalidRoles = [];
        selected.forEach(role => {
            if (role.requiresTicket && role.ticketRegex) {
                try {
                    const regex = new RegExp(role.ticketRegex);
                    if (!regex.test(this.value)) {
                        invalidRoles.push(role.roleName + ' (' + role.ticketRegex + ')');
                    }
                } catch (e) {
                    // Invalid regex, skip validation
                }
            }
        });
        
        if (invalidRoles.length > 0) {
            this.setCustomValidity('Ticket format invalid for: ' + invalidRoles.join(', '));
            this.reportValidity();
        } else {
            this.setCustomValidity('');
        }
    });
    
    // Form validation - ensure at least one role is selected
    requestForm.addEventListener('submit', function(e) {
        const selected = getSelectedRoles();
        if (selected.length === 0) {
            e.preventDefault();
            alert('Please select at least one role');
            return false;
        }
    });
    
    // Initialize form state on page load
    roleChecks.forEach(checkbox => {
        const row = checkbox.closest('.RoleRow');
        if (row && checkbox.checked) row.style.background = 'rgba(30, 102, 245, 0.08)';
    });
    updateFormForSelectedRoles();
})();
</script>
{% endblock %}
