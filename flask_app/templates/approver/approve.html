{% extends "base.html" %}

{% block title %}Review Request - JIT Access{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Review Request</h1>
    <p class="page-subtitle">Review request details and approve or deny</p>
</div>

<div class="card">
    <div class="card-header">Request Details</div>
    <div class="card-body">
        <table class="table">
            <tr>
                <th>Requester:</th>
                <td>{{ request_data.RequesterName or request_data.RequesterLoginName or 'N/A' }}</td>
            </tr>
            <tr>
                <th>Requested Roles:</th>
                <td>
                    {% if request_data.Roles and request_data.Roles|length > 0 %}
                        {% if request_data.Roles|length == 1 %}
                            <strong>{{ request_data.Roles[0].RoleName }}</strong>
                            {% if request_data.Roles[0].Description %}
                                <br><small class="text-muted">{{ request_data.Roles[0].Description }}</small>
                            {% endif %}
                        {% else %}
                            <ul style="margin: 0; padding-left: 1.5rem;">
                                {% for role in request_data.Roles %}
                                <li>
                                    <strong>{{ role.RoleName }}</strong>
                                    {% if role.Description %}
                                        <br><small class="text-muted">{{ role.Description }}</small>
                                    {% endif %}
                                    <br><small class="text-muted">
                                        Max Duration: {{ (role.MaxDurationMinutes / 1440) | int }} day{% if (role.MaxDurationMinutes / 1440) | int != 1 %}s{% endif %}
                                        {% if role.RequiresTicket %} | Requires Ticket{% endif %}
                                    </small>
                                </li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    {% else %}
                        N/A
                    {% endif %}
                </td>
            </tr>
            <tr>
                <th>Department:</th>
                <td>{{ request_data.RequesterDepartment or request_data.UserDeptSnapshot or 'N/A' }}</td>
            </tr>
            <tr>
                <th>Title:</th>
                <td>{{ request_data.UserTitleSnapshot or 'N/A' }}</td>
            </tr>
            <tr>
                <th>Duration:</th>
                <td>{% set days = request_data.RequestedDurationMinutes | minutes_to_days %}{{ days }} day{% if days != 1 %}s{% endif %}</td>
            </tr>
            <tr>
                <th>Justification:</th>
                <td>{{ request_data.Justification or 'N/A' }}</td>
            </tr>
            {% if request_data.TicketRef %}
            <tr>
                <th>Ticket/Reference:</th>
                <td>{{ request_data.TicketRef }}</td>
            </tr>
            {% endif %}
            <tr>
                <th>Requested:</th>
                <td>{{ request_data.CreatedUtc.strftime('%Y-%m-%d %H:%M') if request_data.CreatedUtc else 'N/A' }}</td>
            </tr>
        </table>
    </div>
</div>

<div class="card">
    <div class="card-header">Approve or Deny</div>
    <div class="card-body">
        <form method="POST" id="decisionForm">
            <div class="form-group">
                <label class="form-label" for="decision_comment">Comment (optional)</label>
                <textarea class="form-control" id="decision_comment" name="comment" rows="3" placeholder="Add a comment explaining your decision..."></textarea>
            </div>
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary" onclick="event.preventDefault(); document.getElementById('decisionForm').action='{{ url_for('approver_approve', request_id=request_data.RequestId) }}'; document.getElementById('decisionForm').submit();">Approve</button>
                <button type="submit" class="btn btn-danger" onclick="event.preventDefault(); document.getElementById('decisionForm').action='{{ url_for('approver_deny', request_id=request_data.RequestId) }}'; document.getElementById('decisionForm').submit();">Deny</button>
            </div>
        </form>
    </div>
</div>

<div class="mt-2">
    <a href="{{ url_for('approver_dashboard') }}" class="btn btn-secondary">Back to Approvals</a>
</div>
{% endblock %}

