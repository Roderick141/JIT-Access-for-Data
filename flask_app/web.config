<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <system.webServer>
    <!-- Enable Windows Authentication -->
    <security>
      <authentication>
        <anonymousAuthentication enabled="false" />
        <windowsAuthentication enabled="true" />
      </authentication>
    </security>
    
    <!-- URL Rewrite Rules - Extract Windows Auth from Server Variables -->
    <rewrite>
      <rules>
        <!-- CRITICAL: Extract REMOTE_USER server variable and set as HTTP header -->
        <rule name="Set REMOTE_USER from Server Variables" stopProcessing="false">
          <match url=".*" />
          <conditions>
            <!-- Check if REMOTE_USER server variable exists -->
            <add input="{REMOTE_USER}" pattern=".+" />
          </conditions>
          <serverVariables>
            <!-- Set HTTP header from server variable -->
            <set name="HTTP_REMOTE_USER" value="{REMOTE_USER}" />
            <set name="HTTP_AUTH_USER" value="{REMOTE_USER}" />
          </serverVariables>
          <action type="None" />
        </rule>
        
        <!-- Alternative: Extract from LOGON_USER if REMOTE_USER is empty -->
        <rule name="Set REMOTE_USER from LOGON_USER" stopProcessing="false">
          <match url=".*" />
          <conditions logicalGrouping="MatchAll">
            <add input="{REMOTE_USER}" pattern="^$" />
            <add input="{LOGON_USER}" pattern=".+" />
          </conditions>
          <serverVariables>
            <set name="HTTP_REMOTE_USER" value="{LOGON_USER}" />
            <set name="HTTP_AUTH_USER" value="{LOGON_USER}" />
          </serverVariables>
          <action type="None" />
        </rule>
        
        <!-- Extract from AUTH_USER server variable -->
        <rule name="Set REMOTE_USER from AUTH_USER" stopProcessing="false">
          <match url=".*" />
          <conditions logicalGrouping="MatchAll">
            <add input="{REMOTE_USER}" pattern="^$" />
            <add input="{LOGON_USER}" pattern="^$" />
            <add input="{AUTH_USER}" pattern=".+" />
          </conditions>
          <serverVariables>
            <set name="HTTP_REMOTE_USER" value="{AUTH_USER}" />
            <set name="HTTP_AUTH_USER" value="{AUTH_USER}" />
          </serverVariables>
          <action type="None" />
        </rule>
      </rules>
      <!-- Allow server variables to be set - REQUIRED -->
      <allowedServerVariables>
        <add name="HTTP_REMOTE_USER" />
        <add name="HTTP_AUTH_USER" />
        <add name="HTTP_LOGON_USER" />
      </allowedServerVariables>
    </rewrite>
    
    <!-- HttpPlatformHandler Configuration -->
    <handlers>
      <add name="httpPlatformHandler" path="*" verb="*" 
           modules="httpPlatformHandler" 
           resourceType="Unspecified" />
    </handlers>
    
    <httpPlatform processPath="C:\Python312\python.exe"
                  arguments="C:\inetpub\wwwroot\your-flask-app\flask_app\app.py"
                  stdoutLogEnabled="true"
                  stdoutLogFile="C:\inetpub\logs\stdout.log"
                  startupTimeLimit="20"
                  startupRetryCount="10"
                  forwardWindowsAuthToken="false">
      <environmentVariables>
        <environmentVariable name="PORT" value="%HTTP_PLATFORM_PORT%" />
        <environmentVariable name="DB_SERVER" value="your-sql-server" />
        <environmentVariable name="DB_NAME" value="your-database" />
        <environmentVariable name="DB_USERNAME" value="your-service-account" />
        <environmentVariable name="DB_PASSWORD" value="your-password" />
        <environmentVariable name="SECRET_KEY" value="your-secret-key" />
      </environmentVariables>
    </httpPlatform>
  </system.webServer>
</configuration>
